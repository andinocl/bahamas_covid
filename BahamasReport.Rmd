---
title: "Bahamas Covid Report"
author: "Chris Andino"
date: "8/18/2020"
output: pdf_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load libraries
library(incidence)
library(projections)
library(epitrix)
library(EpiModel)
library(EpiEstim)
library(rmarkdown)
library(knitr)
library(distcrete)
library(Hmisc)
require(tidyr)

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
opts_knit$set(eval.after = "fig.cap")
knitr::opts_chunk$set(fig.pos = '!h')
options(knitr.kable.NA = '')

local_file <- "data/dashboard.csv"
data <- read.csv(local_file,header=TRUE,sep=",")

dates <- data$Date
delta <- character()
for(i in 2:nrow(data)) {
  delta <- rbind(delta,c(data[i,2]-data[i-1,2],data[i,"NewProvidence"]-data[i-1,"NewProvidence"],
                 data[i,"GrandBahama"]-data[i-1,"GrandBahama"],
                 data[i,"Bimini"]-data[i-1,"Bimini"]))
}
localities <- rbind(c(0,0,0,0),delta)  
#localities <- matrix(c(data$ConfirmedCases,data$NewProvidence,data$GrandBahama,data$Bimini),ncol=4)

locality_titles <- c("National","New Providence","Grand Bahama","Bimini")

```

## New Cases

The following graphs show the overall epidemiological curves in the localities:

```{r message=FALSE, warning=FALSE}
# plot total cases
for(val in 1:4) {
  max_y=max(localities[,val],na.rm=TRUE)
  plot(1:length(dates),
       localities[,val],
       type="l",
       xlab="Days since August 2",
       ylab="Cases",
       main=paste("Daily new cases,",locality_titles[val])
  )
  grid(nx = 0, ny = NULL, col = "lightgray", lty = "dotted",
       lwd = par("lwd"), equilogs = TRUE)
  minor.tick(nx=2,ny=2)

}

```
\newpage


## Log graphs

The following graphs are generated by:
$$
x = Number\ of\ Days\ since\ August\ 2\
$$

$$
y = log(Number\ of\ New\ Cases\ this\ day)
$$
The regression line is drawn using the R "lm()" function over the x values.

R0 can be estimated from the slope of the regression line:

$$
y = a + bx
$$
$$
dt = log(2)/b
$$
Dot plots above the regression line are days where the doubling time is decreasing, that is, the spread of the disease is accelerating.  Days below the line, the doubling time is decreasing, meaning case growth is slowing. A negative doubling time means that there are fewer new cases (i.e. a downward trend in infections).

```{r}
localities <- ifelse(localities==0,1,localities)
for(i in 1:4) {
  plot(1:length(dates),
      log(as.numeric(localities[,i])),
      type="p",
      xlab="Days since August 3", 
      ylab="Cases (log)", 
      main=paste("New cases (log scale),",locality_titles[i]), 
      col="blue")
    minor.tick(nx=2,ny=2)
    grid(nx=0, ny=NULL,col="lightgray",lty="dotted",lwd=par("lwd"),equilogs=TRUE)
    fit <- lm(log(as.numeric(localities[,i])) ~ seq(1:15))
    abline(fit, col="blue")
    dt <- round(log(2)/fit$coef[2],2) # Doubling time
    legend(x="topleft",
           y=1,
           adj=c(0,0),
           legend=c(paste("Doubling Time = ",dt,"days")))
}

```
\newpage

## R0 over time

These graphs rely heavily on the Epitrix, EpiEstim, and incidence modules in R.

The following data on serial incidence are drawn from a meta analysis of COVID-19: https://doi.org/10.1002/jmv.26041

$$
\mu = 5.08\ days
$$
$$
\sigma = .18
$$
A gamma distribution is created programatically, and the estimate_R function is run against incidence objects containing the new cases reported each day.  

The function automatically takes a 7-day rolling window, and initial values are exceedingly high.  In general, then, this should only be used to get a rough idea of the approximate rate of transmission about a week ago. 

NOTE: There is simply not enough data for these to be good estimates at the island level.  Additional data at the national level may be of some use.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# predict R0
# coronavirus details from https://doi.org/10.1002/jmv.26041
mu = 5.08  # mean incubation period
sigma = .18 # deviation in meta analysis
cv = mu/sigma
params <- gamma_mucv2shapescale(mu,cv)

#incid_x_start <- c(0,21,37,67) # ends on 7-day rolling window
#n=0

for(i in 1:4) {

    incid <- as.incidence(as.numeric(localities[,i]), 
                          dates=dates, 
                          interval=1)

    si <- distcrete("gamma", 
                  shape=params$shape, 
                  scale=params$scale, 
                  interval=1, w=0.5)
    #pred_1 <- project(incid, R=1.15, si=si, n_days=30, n_sim=1000)
    #f <- fit(incid[start_x:end_x])
    #plot (incid[start_x:end_x], fit=f, color=locality["light",val])
    #f
    res_parametric_si <- estimate_R(incid, 
                          method = "parametric_si",
                          config = make_config(list(
                          mean_si=mu,
                          std_si=sigma)))
    
    #@TODO get dates in the x axis labels
    #plot(res_parametric_si, legend=FALSE)
    plot(res_parametric_si$R[,3],
         ylab="R0",
         xlab="Days since August 3",
         type="l",
         main=paste("R0 over time,",locality_titles[i]),
         col="blue"
        )
    minor.tick(ny=2)
    #axis(1,incid$date,format(incid$date, "%b %d"), cex.axis = .7)
    grid(nx = 0, ny = NULL, col = "lightgray", lty = "dotted",
           lwd = par("lwd"), equilogs = TRUE)
    
}
```
